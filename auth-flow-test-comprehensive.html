<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication Flow - E-commerce</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            margin: -30px -30px 30px -30px; 
            border-radius: 10px 10px 0 0; 
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa; 
        }
        .test-controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.3s; 
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        input, select { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            margin: 5px; 
            font-size: 14px; 
        }
        .result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }
        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .cart-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .redirect-info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Authentication Flow Testing - E-commerce System</h1>
            <p>Comprehensive testing tool for user authentication, cart management, and redirect logic</p>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('auth')">Authentication</div>
            <div class="tab" onclick="switchTab('cart')">Shopping Cart</div>
            <div class="tab" onclick="switchTab('redirect')">Redirect Logic</div>
            <div class="tab" onclick="switchTab('integration')">Full Integration</div>
        </div>

        <!-- Authentication Tab -->
        <div id="auth-tab" class="tab-content active">
            <div class="test-section">
                <h3>üîë User Authentication Tests</h3>
                
                <div class="test-controls">
                    <div>
                        <h4>Register New User</h4>
                        <input type="email" id="regEmail" placeholder="Email" value="test@example.com">
                        <input type="text" id="regFirstName" placeholder="First Name" value="John">
                        <input type="text" id="regLastName" placeholder="Last Name" value="Doe">
                        <input type="password" id="regPassword" placeholder="Password" value="Test123!@#">
                        <input type="tel" id="regPhone" placeholder="Phone" value="0123456789">
                        <button onclick="testRegistration()">Register User</button>
                    </div>
                    
                    <div>
                        <h4>Login User</h4>
                        <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
                        <input type="password" id="loginPassword" placeholder="Password" value="Test123!@#">
                        <label><input type="checkbox" id="rememberMe"> Remember me</label>
                        <button onclick="testLogin()">Login</button>
                    </div>
                </div>

                <div class="test-controls">
                    <button onclick="checkAuthStatus()">Check Auth Status</button>
                    <button onclick="testLogout()" class="danger">Logout</button>
                    <button onclick="checkUserStatus()">Check User Status</button>
                    <button onclick="testTokenRefresh()" class="secondary">Refresh Token</button>
                </div>

                <div id="authResult" class="result info">Ready to test authentication...</div>
            </div>
        </div>

        <!-- Shopping Cart Tab -->
        <div id="cart-tab" class="tab-content">
            <div class="test-section">
                <h3>üõí Shopping Cart Tests</h3>
                
                <div class="test-controls">
                    <div>
                        <h4>Add to Cart</h4>
                        <input type="number" id="productId" placeholder="Product ID" value="1">
                        <input type="number" id="quantity" placeholder="Quantity" value="2" min="1">
                        <input type="text" id="productName" placeholder="Product Name" value="Test Product">
                        <input type="number" id="productPrice" placeholder="Price" value="29.99" step="0.01">
                        <button onclick="testAddToCart()">Add to Cart</button>
                    </div>
                    
                    <div>
                        <h4>Cart Operations</h4>
                        <button onclick="testGetCart()">Get Cart</button>
                        <button onclick="testClearCart()" class="danger">Clear Cart</button>
                        <button onclick="testCartSync()" class="secondary">Sync Cart</button>
                    </div>
                </div>

                <div id="cartItems" class="test-section">
                    <h4>Cart Items</h4>
                    <div id="cartItemsList">No items in cart</div>
                </div>

                <div id="cartResult" class="result info">Ready to test cart operations...</div>
            </div>
        </div>

        <!-- Redirect Logic Tab -->
        <div id="redirect-tab" class="tab-content">
            <div class="test-section">
                <h3>üîÑ Redirect Logic Tests</h3>
                
                <div class="redirect-info">
                    <strong>E-commerce Redirect Scenarios:</strong>
                    <ul>
                        <li>Guest adds items to cart ‚Üí Login required ‚Üí Redirect back to cart/checkout</li>
                        <li>User accesses protected page ‚Üí Login ‚Üí Redirect to original page</li>
                        <li>Authenticated user visits login page ‚Üí Redirect to homepage</li>
                        <li>Shopping session preservation during authentication</li>
                    </ul>
                </div>

                <div class="test-controls">
                    <div>
                        <h4>Set Return URL</h4>
                        <select id="returnUrlSelect">
                            <option value="/cart">Shopping Cart</option>
                            <option value="/checkout">Checkout Page</option>
                            <option value="/profile">User Profile</option>
                            <option value="/orders">Order History</option>
                            <option value="/products/123">Product Detail</option>
                        </select>
                        <button onclick="testSetReturnUrl()">Set Return URL</button>
                    </div>
                    
                    <div>
                        <h4>Redirect Tests</h4>
                        <button onclick="testGuestRedirect()">Test Guest Redirect</button>
                        <button onclick="testAuthRedirect()" class="secondary">Test Auth Redirect</button>
                        <button onclick="testProtectedRoute()">Access Protected Route</button>
                    </div>
                </div>

                <div id="redirectResult" class="result info">Ready to test redirect logic...</div>
            </div>
        </div>

        <!-- Full Integration Tab -->
        <div id="integration-tab" class="tab-content">
            <div class="test-section">
                <h3>üîó Full Integration Tests</h3>
                
                <div class="test-controls">
                    <button onclick="testFullUserJourney()">Test Complete User Journey</button>
                    <button onclick="testGuestToUserFlow()" class="secondary">Test Guest‚ÜíUser Flow</button>
                    <button onclick="testCartPersistence()">Test Cart Persistence</button>
                    <button onclick="testSessionManagement()">Test Session Management</button>
                </div>

                <div id="integrationResult" class="result info">Ready to test full integration...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä System Status</h3>
            <div class="test-controls">
                <div>
                    <span class="status-indicator status-offline" id="backendStatus"></span>
                    <span>Backend API: <span id="backendStatusText">Checking...</span></span>
                </div>
                <div>
                    <span class="status-indicator status-offline" id="authStatus"></span>
                    <span>Authentication: <span id="authStatusText">Not authenticated</span></span>
                </div>
                <div>
                    <span class="status-indicator status-offline" id="cartStatus"></span>
                    <span>Cart Service: <span id="cartStatusText">Checking...</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        // Authentication Tests
        async function testRegistration() {
            const result = document.getElementById('authResult');
            result.className = 'result info';
            result.textContent = 'Registering user...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('regEmail').value,
                        firstName: document.getElementById('regFirstName').value,
                        lastName: document.getElementById('regLastName').value,
                        password: document.getElementById('regPassword').value,
                        phoneNumber: document.getElementById('regPhone').value,
                        dateOfBirth: '1990-01-01'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Registration successful!\nMessage: ${data.message}\nNext step: Check email for verification code`;
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Registration failed!\nError: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Network error: ${error.message}`;
            }
        }

        async function testLogin() {
            const result = document.getElementById('authResult');
            result.className = 'result info';
            result.textContent = 'Logging in...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Store auth data
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    result.className = 'result success';
                    result.textContent = `‚úÖ Login successful!\nUser: ${data.user.firstName} ${data.user.lastName}\nEmail: ${data.user.email}\nRoles: ${data.user.roles.join(', ')}`;
                    
                    // Update auth status
                    updateAuthStatus(true);
                    
                    // Test redirect logic
                    testRedirectAfterLogin();
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Login failed!\nError: ${data.message || 'Invalid credentials'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Network error: ${error.message}`;
            }
        }

        async function checkAuthStatus() {
            const result = document.getElementById('authResult');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    result.className = 'result success';
                    result.textContent = `‚úÖ User is authenticated\nUser: ${userData.firstName} ${userData.lastName}\nEmail: ${userData.email}\nToken present: Yes`;
                    updateAuthStatus(true);
                } catch (error) {
                    result.className = 'result error';
                    result.textContent = `‚ùå Invalid user data in localStorage`;
                    updateAuthStatus(false);
                }
            } else {
                result.className = 'result info';
                result.textContent = `‚ÑπÔ∏è User is not authenticated`;
                updateAuthStatus(false);
            }
        }

        function testLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            const result = document.getElementById('authResult');
            result.className = 'result success';
            result.textContent = '‚úÖ Logged out successfully';
            
            updateAuthStatus(false);
        }

        // Cart Tests
        async function testAddToCart() {
            const result = document.getElementById('cartResult');
            result.className = 'result info';
            result.textContent = 'Adding to cart...';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        productId: parseInt(document.getElementById('productId').value),
                        quantity: parseInt(document.getElementById('quantity').value)
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Added to cart successfully!\nTotal items: ${data.totalQuantity}\nTotal price: $${data.totalPrice.toFixed(2)}`;
                    updateCartDisplay(data.items);
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Failed to add to cart: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Network error: ${error.message}`;
            }
        }

        async function testGetCart() {
            const result = document.getElementById('cartResult');
            result.className = 'result info';
            result.textContent = 'Getting cart...';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/cart', {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Cart retrieved successfully!\nTotal items: ${data.totalQuantity}\nTotal price: $${data.totalPrice.toFixed(2)}`;
                    updateCartDisplay(data.items);
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Failed to get cart: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Network error: ${error.message}`;
            }
        }

        // Redirect Tests
        function testSetReturnUrl() {
            const returnUrl = document.getElementById('returnUrlSelect').value;
            sessionStorage.setItem('returnUrl', returnUrl);
            
            const result = document.getElementById('redirectResult');
            result.className = 'result success';
            result.textContent = `‚úÖ Return URL set to: ${returnUrl}`;
        }

        function testRedirectAfterLogin() {
            const returnUrl = sessionStorage.getItem('returnUrl');
            const result = document.getElementById('redirectResult');
            
            if (returnUrl) {
                result.className = 'result success';
                result.textContent = `‚úÖ Would redirect to: ${returnUrl}\n(In real app, user would be redirected now)`;
                sessionStorage.removeItem('returnUrl');
            } else {
                result.className = 'result info';
                result.textContent = `‚ÑπÔ∏è Would redirect to homepage (default)`;
            }
        }

        // Integration Tests
        async function testFullUserJourney() {
            const result = document.getElementById('integrationResult');
            result.className = 'result info';
            result.textContent = 'Testing complete user journey...\n\n';

            let log = '';

            // Step 1: Add to cart as guest
            log += '1. Adding product to cart as guest...\n';
            try {
                const cartResponse = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId: 1, quantity: 1 })
                });
                log += cartResponse.ok ? '   ‚úÖ Added to guest cart\n' : '   ‚ùå Failed to add to guest cart\n';
            } catch (error) {
                log += '   ‚ùå Error adding to guest cart\n';
            }

            // Step 2: Try to checkout (should require login)
            log += '2. Attempting checkout (should require login)...\n';
            sessionStorage.setItem('returnUrl', '/checkout');
            log += '   ‚úÖ Return URL set to /checkout\n';

            // Step 3: Login
            log += '3. Logging in user...\n';
            try {
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'Test123!@#'
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    localStorage.setItem('token', loginData.token);
                    localStorage.setItem('user', JSON.stringify(loginData.user));
                    log += '   ‚úÖ Login successful\n';
                } else {
                    log += '   ‚ùå Login failed\n';
                }
            } catch (error) {
                log += '   ‚ùå Login error\n';
            }

            // Step 4: Cart should be preserved/synced
            log += '4. Checking cart after login...\n';
            try {
                const token = localStorage.getItem('token');
                const cartResponse = await fetch('/api/cart', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (cartResponse.ok) {
                    const cartData = await cartResponse.json();
                    log += `   ‚úÖ Cart preserved: ${cartData.totalQuantity} items\n`;
                } else {
                    log += '   ‚ùå Cart sync failed\n';
                }
            } catch (error) {
                log += '   ‚ùå Cart check error\n';
            }

            // Step 5: Redirect should happen
            log += '5. Redirect logic...\n';
            const returnUrl = sessionStorage.getItem('returnUrl');
            if (returnUrl) {
                log += `   ‚úÖ Would redirect to: ${returnUrl}\n`;
                sessionStorage.removeItem('returnUrl');
            } else {
                log += '   ‚ÑπÔ∏è Would redirect to homepage\n';
            }

            result.textContent = log;
            result.className = 'result success';
        }

        // Utility functions
        function updateAuthStatus(isAuthenticated) {
            const statusElement = document.getElementById('authStatus');
            const textElement = document.getElementById('authStatusText');
            
            if (isAuthenticated) {
                statusElement.className = 'status-indicator status-online';
                textElement.textContent = 'Authenticated';
            } else {
                statusElement.className = 'status-indicator status-offline';
                textElement.textContent = 'Not authenticated';
            }
        }

        function updateCartDisplay(items) {
            const cartList = document.getElementById('cartItemsList');
            
            if (!items || items.length === 0) {
                cartList.innerHTML = 'No items in cart';
                return;
            }

            cartList.innerHTML = items.map(item => `
                <div class="cart-item">
                    <div>
                        <strong>${item.productName}</strong><br>
                        Quantity: ${item.quantity} √ó $${item.price.toFixed(2)}
                    </div>
                    <div>
                        <strong>$${(item.quantity * item.price).toFixed(2)}</strong>
                    </div>
                </div>
            `).join('');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            testGetCart();
            
            // Check backend status
            fetch('/api/health')
                .then(response => {
                    const statusElement = document.getElementById('backendStatus');
                    const textElement = document.getElementById('backendStatusText');
                    
                    if (response.ok) {
                        statusElement.className = 'status-indicator status-online';
                        textElement.textContent = 'Online';
                    } else {
                        statusElement.className = 'status-indicator status-offline';
                        textElement.textContent = 'Error';
                    }
                })
                .catch(() => {
                    document.getElementById('backendStatus').className = 'status-indicator status-offline';
                    document.getElementById('backendStatusText').textContent = 'Offline';
                });
        });
    </script>
</body>
</html>
