<!DOCTYPE html>
<html>
<head>
    <title>Cart & Payment System - Manual Test Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; }
        .test-result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        .api-test { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üõíüí≥ Cart & Payment System Testing Interface</h1>
    
    <div class="test-section">
        <h2>üîß 1. Backend API Health Check</h2>
        <button onclick="testBackendHealth()">Test Backend Health</button>
        <div id="backend-health-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üîê 2. Authentication Test</h2>
        <h3>Register New User</h3>
        <input type="email" id="reg-email" placeholder="Email" value="testuser@example.com">
        <input type="password" id="reg-password" placeholder="Password" value="Test123!">
        <input type="text" id="reg-firstname" placeholder="First Name" value="Test">
        <input type="text" id="reg-lastname" placeholder="Last Name" value="User">
        <button onclick="testRegister()">Register User</button>
        
        <h3>Login User</h3>
        <input type="email" id="login-email" placeholder="Email" value="testuser@example.com">
        <input type="password" id="login-password" placeholder="Password" value="Test123!">
        <button onclick="testLogin()">Login User</button>
        
        <div id="auth-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üõí 3. Shopping Cart Test</h2>
        <button onclick="testGetCart()">Get Cart</button>
        <button onclick="testAddToCart()">Add Test Product to Cart</button>
        <button onclick="testUpdateCartItem()">Update Cart Item</button>
        <button onclick="testRemoveCartItem()">Remove Cart Item</button>
        <button onclick="testClearCart()">Clear Cart</button>
        <div id="cart-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üí≥ 4. Checkout & Payment Test</h2>
        <h3>Test Checkout Data</h3>
        <textarea id="checkout-data" rows="10">{
  "shippingAddress": {
    "fullName": "Test User",
    "addressLine1": "123 Test Street",
    "addressLine2": "Apt 1",
    "city": "Ho Chi Minh City",
    "province": "Ho Chi Minh",
    "zipCode": "700000"
  },
  "contactInfo": {
    "email": "testuser@example.com",
    "phone": "+84123456789",
    "notes": "Test order"
  },
  "paymentMethod": "vnpay"
}</textarea>
        
        <button onclick="testCheckoutCOD()">Test COD Checkout</button>
        <button onclick="testCheckoutVNPay()">Test VNPay Checkout</button>
        <div id="checkout-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üí∞ 5. VNPay Integration Test</h2>
        <button onclick="testVNPayReturn()">Test VNPay Return Handler</button>
        <button onclick="testVNPayIPN()">Test VNPay IPN Handler</button>
        <div id="vnpay-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üë®‚Äçüíº 6. Admin Panel Test</h2>
        <button onclick="testAdminAccess()">Test Admin Access</button>
        <button onclick="testPaymentsAdmin()">Test Payments Admin</button>
        <div id="admin-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üìä 7. Test Results Summary</h2>
        <div id="test-summary" class="test-result"></div>
        <button onclick="generateTestReport()">Generate Test Report</button>
    </div>

    <script>
        const API_BASE = 'https://localhost:5001/api';
        const BACKEND_BASE = 'https://localhost:5001';
        let authToken = null;
        let testResults = {};

        // Utility functions
        function logResult(section, message, success = true) {
            const resultDiv = document.getElementById(section + '-result');
            const className = success ? 'success' : (success === null ? 'warning' : 'error');
            resultDiv.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
            testResults[section] = testResults[section] || [];
            testResults[section].push({message, success, timestamp: new Date()});
        }

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : '',
                        ...options.headers
                    }
                });
                
                const data = await response.text();
                let jsonData = null;
                try {
                    jsonData = JSON.parse(data);
                } catch(e) {
                    // Not JSON response
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data: jsonData || data,
                    response
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    error: error.message,
                    data: null
                };
            }
        }

        // Test functions
        async function testBackendHealth() {
            logResult('backend-health', 'Testing backend health...', null);
            
            const result = await apiCall(BACKEND_BASE);
            if (result.ok) {
                logResult('backend-health', `‚úÖ Backend is healthy (${result.status})`, true);
            } else {
                logResult('backend-health', `‚ùå Backend health check failed (${result.status})`, false);
            }
        }

        async function testRegister() {
            logResult('auth', 'Testing user registration...', null);
            
            const userData = {
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                firstName: document.getElementById('reg-firstname').value,
                lastName: document.getElementById('reg-lastname').value,
                confirmPassword: document.getElementById('reg-password').value
            };

            const result = await apiCall(`${API_BASE}/auth/register`, {
                method: 'POST',
                body: JSON.stringify(userData)
            });

            if (result.ok) {
                logResult('auth', `‚úÖ User registration successful`, true);
                logResult('auth', `Response: ${JSON.stringify(result.data)}`, true);
            } else {
                logResult('auth', `‚ùå User registration failed (${result.status})`, false);
                logResult('auth', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testLogin() {
            logResult('auth', 'Testing user login...', null);
            
            const loginData = {
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value
            };

            const result = await apiCall(`${API_BASE}/auth/login`, {
                method: 'POST',
                body: JSON.stringify(loginData)
            });

            if (result.ok && result.data?.token) {
                authToken = result.data.token;
                logResult('auth', `‚úÖ Login successful. Token received.`, true);
                logResult('auth', `User: ${result.data.user?.email}`, true);
            } else {
                logResult('auth', `‚ùå Login failed (${result.status})`, false);
                logResult('auth', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testGetCart() {
            logResult('cart', 'Testing get cart...', null);
            
            const result = await apiCall(`${API_BASE}/ShoppingCart`);
            
            if (result.ok) {
                logResult('cart', `‚úÖ Get cart successful`, true);
                logResult('cart', `Cart items: ${result.data?.items?.length || 0}`, true);
            } else if (result.status === 401) {
                logResult('cart', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('cart', `‚ùå Get cart failed (${result.status})`, false);
                logResult('cart', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testAddToCart() {
            logResult('cart', 'Testing add to cart...', null);
            
            const cartData = {
                productId: 1,
                quantity: 2
            };

            const result = await apiCall(`${API_BASE}/ShoppingCart/items`, {
                method: 'POST',
                body: JSON.stringify(cartData)
            });

            if (result.ok) {
                logResult('cart', `‚úÖ Add to cart successful`, true);
            } else if (result.status === 401) {
                logResult('cart', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('cart', `‚ùå Add to cart failed (${result.status})`, false);
                logResult('cart', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testUpdateCartItem() {
            logResult('cart', 'Testing update cart item...', null);
            
            const updateData = {
                cartItemId: 1,
                quantity: 3
            };

            const result = await apiCall(`${API_BASE}/ShoppingCart/items`, {
                method: 'PUT',
                body: JSON.stringify(updateData)
            });

            if (result.ok) {
                logResult('cart', `‚úÖ Update cart item successful`, true);
            } else if (result.status === 401) {
                logResult('cart', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('cart', `‚ùå Update cart item failed (${result.status})`, false);
            }
        }

        async function testRemoveCartItem() {
            logResult('cart', 'Testing remove cart item...', null);
            
            const result = await apiCall(`${API_BASE}/ShoppingCart/items/1`, {
                method: 'DELETE'
            });

            if (result.ok) {
                logResult('cart', `‚úÖ Remove cart item successful`, true);
            } else if (result.status === 401) {
                logResult('cart', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('cart', `‚ùå Remove cart item failed (${result.status})`, false);
            }
        }

        async function testClearCart() {
            logResult('cart', 'Testing clear cart...', null);
            
            const result = await apiCall(`${API_BASE}/ShoppingCart/clear`, {
                method: 'DELETE'
            });

            if (result.ok) {
                logResult('cart', `‚úÖ Clear cart successful`, true);
            } else if (result.status === 401) {
                logResult('cart', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('cart', `‚ùå Clear cart failed (${result.status})`, false);
            }
        }

        async function testCheckoutCOD() {
            logResult('checkout', 'Testing COD checkout...', null);
            
            const checkoutData = JSON.parse(document.getElementById('checkout-data').value);
            checkoutData.paymentMethod = 'cash_on_delivery';

            const result = await apiCall(`${API_BASE}/orders/checkout`, {
                method: 'POST',
                body: JSON.stringify(checkoutData)
            });

            if (result.ok) {
                logResult('checkout', `‚úÖ COD checkout successful`, true);
                logResult('checkout', `Order: ${JSON.stringify(result.data)}`, true);
            } else if (result.status === 401) {
                logResult('checkout', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('checkout', `‚ùå COD checkout failed (${result.status})`, false);
                logResult('checkout', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testCheckoutVNPay() {
            logResult('checkout', 'Testing VNPay checkout...', null);
            
            const checkoutData = JSON.parse(document.getElementById('checkout-data').value);
            checkoutData.paymentMethod = 'vnpay';

            const result = await apiCall(`${API_BASE}/orders/checkout`, {
                method: 'POST',
                body: JSON.stringify(checkoutData)
            });

            if (result.ok) {
                logResult('checkout', `‚úÖ VNPay checkout successful`, true);
                if (result.data?.paymentUrl) {
                    logResult('checkout', `Payment URL: ${result.data.paymentUrl}`, true);
                }
            } else if (result.status === 401) {
                logResult('checkout', `‚ö†Ô∏è Unauthorized - Please login first`, null);
            } else {
                logResult('checkout', `‚ùå VNPay checkout failed (${result.status})`, false);
                logResult('checkout', `Error: ${result.data || result.error}`, false);
            }
        }

        async function testVNPayReturn() {
            logResult('vnpay', 'Testing VNPay return handler...', null);
            
            const result = await apiCall(`${API_BASE}/VNPay/return?vnp_ResponseCode=00&vnp_TxnRef=123&vnp_TransactionNo=456&vnp_Amount=10000`);

            if (result.status === 302 || result.ok) {
                logResult('vnpay', `‚úÖ VNPay return handler accessible`, true);
            } else {
                logResult('vnpay', `‚ùå VNPay return handler failed (${result.status})`, false);
            }
        }

        async function testVNPayIPN() {
            logResult('vnpay', 'Testing VNPay IPN handler...', null);
            
            const result = await apiCall(`${API_BASE}/VNPay/ipn`, {
                method: 'POST'
            });

            if (result.ok || result.status === 400) {
                logResult('vnpay', `‚úÖ VNPay IPN handler accessible`, true);
            } else {
                logResult('vnpay', `‚ùå VNPay IPN handler failed (${result.status})`, false);
            }
        }

        async function testAdminAccess() {
            logResult('admin', 'Testing admin panel access...', null);
            
            const result = await apiCall(`${BACKEND_BASE}/admin`);

            if (result.status === 302 || result.ok) {
                logResult('admin', `‚úÖ Admin panel accessible`, true);
            } else if (result.status === 401 || result.status === 403) {
                logResult('admin', `‚ö†Ô∏è Admin access requires authentication/authorization`, null);
            } else {
                logResult('admin', `‚ùå Admin panel access failed (${result.status})`, false);
            }
        }

        async function testPaymentsAdmin() {
            logResult('admin', 'Testing payments admin...', null);
            
            const result = await apiCall(`${BACKEND_BASE}/admin/PaymentsAdmin`);

            if (result.status === 302 || result.ok) {
                logResult('admin', `‚úÖ Payments admin accessible`, true);
            } else if (result.status === 401 || result.status === 403) {
                logResult('admin', `‚ö†Ô∏è Payments admin requires authentication/authorization`, null);
            } else {
                logResult('admin', `‚ùå Payments admin access failed (${result.status})`, false);
            }
        }

        function generateTestReport() {
            const summary = document.getElementById('test-summary');
            let report = '<h3>üìä Test Results Summary</h3>';
            
            for (const [section, results] of Object.entries(testResults)) {
                const successCount = results.filter(r => r.success === true).length;
                const failCount = results.filter(r => r.success === false).length;
                const warningCount = results.filter(r => r.success === null).length;
                
                report += `<div class="api-test">
                    <strong>${section.toUpperCase()}</strong>: 
                    ‚úÖ ${successCount} success, 
                    ‚ùå ${failCount} failed, 
                    ‚ö†Ô∏è ${warningCount} warnings
                </div>`;
            }
            
            summary.innerHTML = report;
        }

        // Auto-run basic tests on page load
        window.onload = async function() {
            await testBackendHealth();
            logResult('auth', 'üí° Tip: Register a new user first, then login to test cart and checkout features', null);
        };
    </script>
</body>
</html>
