<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Backend CORS & Connectivity Test</h1>
    <p>This test checks if the backend server is accessible from the browser and if CORS is configured correctly.</p>
    
    <button onclick="runTests()">Run All Tests</button>
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5000';
        
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">Running tests...</div>';
            
            const tests = [
                { name: 'Port Connectivity', test: testPortConnectivity },
                { name: 'Basic Fetch', test: testBasicFetch },
                { name: 'CORS Headers', test: testCorsHeaders },
                { name: 'Articles API', test: testArticlesAPI },
                { name: 'Search API', test: testSearchAPI }
            ];
            
            let html = '<h2>Test Results:</h2>';
            
            for (const testCase of tests) {
                html += `<div class="result"><h3>${testCase.name}</h3>`;
                try {
                    const result = await testCase.test();
                    html += `<div class="success">✅ PASS: ${result}</div>`;
                } catch (error) {
                    html += `<div class="error">❌ FAIL: ${error.message}</div>`;
                }
                html += '</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        async function testPortConnectivity() {
            // Simple connectivity test
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            try {
                const response = await fetch(`${API_BASE}`, { 
                    signal: controller.signal,
                    mode: 'no-cors'
                });
                clearTimeout(timeoutId);
                return 'Port 5000 is accessible';
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Connection timeout - backend may not be running');
                }
                throw error;
            }
        }
        
        async function testBasicFetch() {
            const response = await fetch(`${API_BASE}/api/articles/published`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return `Successfully fetched ${data.length} articles`;
        }
        
        async function testCorsHeaders() {
            const response = await fetch(`${API_BASE}/api/articles/published`);
            
            const corsHeader = response.headers.get('Access-Control-Allow-Origin');
            const methodsHeader = response.headers.get('Access-Control-Allow-Methods');
            
            if (!corsHeader) {
                throw new Error('Missing Access-Control-Allow-Origin header');
            }
            
            return `CORS configured: Origin=${corsHeader}, Methods=${methodsHeader || 'not specified'}`;
        }
        
        async function testArticlesAPI() {
            const response = await fetch(`${API_BASE}/api/articles/published`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const articles = await response.json();
            
            if (!Array.isArray(articles)) {
                throw new Error('Response is not an array');
            }
            
            const publishedCount = articles.filter(a => a.isPublished).length;
            return `Found ${articles.length} articles (${publishedCount} published)`;
        }
        
        async function testSearchAPI() {
            const searchTerm = 'yoga';
            const response = await fetch(`${API_BASE}/api/articles/search?q=${encodeURIComponent(searchTerm)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const results = await response.json();
            
            if (!Array.isArray(results)) {
                throw new Error('Search results is not an array');
            }
            
            return `Search for "${searchTerm}" returned ${results.length} results`;
        }
        
        // Auto-run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
