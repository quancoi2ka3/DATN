<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart & Checkout JSON Parse Error Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f9fff9; }
        .error { border-color: #f44336; background-color: #fff5f5; }
        .warning { border-color: #ff9800; background-color: #fffbf0; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .cart-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí Cart & Checkout JSON Parse Error Fix Test</h1>
          <div class="test-section">
            <h3>üìã Test Configuration</h3>
            <p><strong>Backend URL:</strong> <span id="backendUrl">http://localhost:5000</span></p>
            <p><strong>Alternative URL:</strong> <span>https://localhost:5001</span></p>
            <p><strong>Test Product ID:</strong> <span id="testProductId">1</span></p>
            <p><strong>Session ID:</strong> <span id="sessionId">guest-session</span></p>
            <p><strong>Note:</strong> Make sure backend server is running first!</p>
        </div>

        <div class="test-section">
            <h3>üîß Test Controls</h3>
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
            <button onclick="testAddToCart()">‚ûï Test Add to Cart</button>
            <button onclick="testGetCart()">üìã Test Get Cart</button>
            <button onclick="testCheckout()">üí≥ Test Checkout</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üõí Current Cart</h3>
            <div id="cartDisplay"></div>
        </div>

        <div class="test-section">
            <h3>üìù Debug Log</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateResults(testName, success, message) {
            const resultsDiv = document.getElementById('testResults');
            const statusClass = success ? 'success' : 'error';
            const statusIcon = success ? '‚úÖ' : '‚ùå';
            
            resultsDiv.innerHTML += `
                <div class="status ${statusClass}">
                    ${statusIcon} ${testName}: ${message}
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('debugLog').textContent = '';
            document.getElementById('cartDisplay').innerHTML = '';
        }

        async function testAddToCart() {
            try {
                log('üîÑ Testing Add to Cart...');
                
                const response = await fetch(`${API_BASE}/api/ShoppingCart/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: 1,
                        quantity: 2
                    }),
                    credentials: 'include'
                });

                log(`üì° Add to cart response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.text();
                log(`üì¶ Add to cart result: ${result}`);
                
                updateResults('Add to Cart', true, 'Successfully added item to cart');
                return true;
            } catch (error) {
                log(`‚ùå Add to cart error: ${error.message}`);
                updateResults('Add to Cart', false, error.message);
                return false;
            }
        }

        async function testGetCart() {
            try {
                log('üîÑ Testing Get Cart...');
                
                const response = await fetch(`${API_BASE}/api/ShoppingCart/items`, {
                    credentials: 'include'
                });

                log(`üì° Get cart response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const cart = await response.json();
                log(`üõí Cart data: ${JSON.stringify(cart, null, 2)}`);
                
                // Display cart
                displayCart(cart);
                
                const itemCount = cart.items ? cart.items.length : 0;
                updateResults('Get Cart', true, `Found ${itemCount} items in cart`);
                return cart;
            } catch (error) {
                log(`‚ùå Get cart error: ${error.message}`);
                updateResults('Get Cart', false, error.message);
                return null;
            }
        }

        async function testCheckout() {
            try {
                log('üîÑ Testing Checkout...');
                
                const checkoutData = {
                    shippingAddress: {
                        fullName: "Test User",
                        addressLine1: "123 Test Street",
                        addressLine2: "Apt 456",
                        city: "Test City",
                        province: "Test Province",
                        zipCode: "12345"
                    },
                    contactInfo: {
                        email: "test@example.com",
                        phone: "0123456789",
                        notes: "Test order"
                    },
                    paymentMethod: "cash"
                };

                log(`üí≥ Checkout data: ${JSON.stringify(checkoutData, null, 2)}`);
                
                const response = await fetch(`${API_BASE}/api/orders/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(checkoutData),
                    credentials: 'include'
                });

                log(`üì° Checkout response status: ${response.status}`);
                log(`üì° Checkout response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Checkout error response: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Try to parse JSON response
                const responseText = await response.text();
                log(`üì¶ Raw checkout response: ${responseText}`);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                    log(`‚úÖ Parsed checkout result: ${JSON.stringify(result, null, 2)}`);
                } catch (parseError) {
                    log(`‚ùå JSON parse error: ${parseError.message}`);
                    throw new Error(`Failed to parse JSON response: ${responseText}`);
                }
                
                if (result.success && result.order) {
                    updateResults('Checkout', true, `Order created successfully with ID: ${result.order.id}`);
                    return result;
                } else {
                    throw new Error('Invalid response format: missing success or order');
                }
            } catch (error) {
                log(`‚ùå Checkout error: ${error.message}`);
                updateResults('Checkout', false, error.message);
                return null;
            }
        }

        function displayCart(cart) {
            const cartDiv = document.getElementById('cartDisplay');
            
            if (!cart || !cart.items || cart.items.length === 0) {
                cartDiv.innerHTML = '<p>üõí Cart is empty</p>';
                return;
            }

            let html = `<p><strong>Total Items:</strong> ${cart.items.length}</p>`;
            html += `<p><strong>Total Amount:</strong> $${cart.totalAmount || 0}</p>`;
            
            cart.items.forEach(item => {
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.itemName || 'Unknown Product'}</strong><br>
                            <small>ID: ${item.id} | Product ID: ${item.productId || 'N/A'}</small>
                        </div>
                        <div>
                            <span>Qty: ${item.quantity}</span><br>
                            <span>$${item.unitPrice || 0}</span>
                        </div>
                    </div>
                `;
            });
            
            cartDiv.innerHTML = html;
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Starting comprehensive cart and checkout test...');
            
            // Test 1: Add to cart
            const addSuccess = await testAddToCart();
            if (!addSuccess) {
                log('‚ùå Add to cart failed, stopping tests');
                return;
            }
            
            // Wait a bit
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: Get cart
            const cart = await testGetCart();
            if (!cart) {
                log('‚ùå Get cart failed, stopping tests');
                return;
            }
            
            // Wait a bit
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 3: Checkout
            const checkoutResult = await testCheckout();
            if (!checkoutResult) {
                log('‚ùå Checkout failed');
                return;
            }
            
            log('‚úÖ All tests completed successfully!');
            updateResults('Overall Test', true, 'All tests passed - JSON parse error is fixed!');
        }

        // Initialize
        window.onload = function() {
            log('üîß JSON Parse Error Fix Test initialized');
            log('üìã Ready to test cart and checkout functionality');
        };
    </script>
</body>
</html>
